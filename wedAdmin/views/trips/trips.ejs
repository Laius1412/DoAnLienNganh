<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Quáº£n lÃ½ chuyáº¿n Ä‘i</h2>
    <div class="d-flex gap-2">
      <input id="searchInput" class="form-control" placeholder="ğŸ” TÃ¬m kiáº¿m chuyáº¿n Ä‘i..." onkeyup="filterTable()" />
      <button class="btn btn-danger d-none" id="deleteSelectedBtn" onclick="submitDeleteSelected()">ğŸ—‘ï¸ XÃ³a Ä‘Ã£ chá»n</button>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTripModal">+ ThÃªm chuyáº¿n Ä‘i</button>
    </div>
  </div>

  <% if (addTripError) { %>
    <div class="alert alert-danger">
      <strong>Lá»—i thÃªm chuyáº¿n Ä‘i:</strong> <%= addTripError %>
    </div>
  <% } %>

  <% if (editTripError) { %>
    <div class="alert alert-danger">
      <strong>Lá»—i sá»­a chuyáº¿n Ä‘i:</strong> <%= editTripError %>
    </div>
  <% } %>

  <form method="POST" id="deleteSelectedForm" action="/trips/delete-multiple">
    <table class="table table-hover align-middle" id="tripTable">
      <thead class="table-light">
        <tr>
          <th><input type="checkbox" id="selectAll" /></th>
          <th>MÃ£ chuyáº¿n</th>
          <th>TÃªn chuyáº¿n</th>
          <th>ÄÆ°á»ng Ä‘i</th>
          <th>Äiá»ƒm xuáº¥t phÃ¡t</th>
          <th>Äiá»ƒm Ä‘áº¿n</th>
          <th>HÃ nh Ä‘á»™ng</th>
        </tr>
      </thead>
      <tbody>
        <% if (trips.length === 0) { %>
          <tr><td colspan="7" class="text-center">ChÆ°a cÃ³ chuyáº¿n Ä‘i nÃ o</td></tr>
        <% } else { %>
          <% trips.forEach(trip => { %>
            <tr>
              <td><input type="checkbox" name="selectedIds" value="<%= trip.id %>" class="rowCheckbox" /></td>
              <td><%= trip.tripCode %></td>
              <td><strong><%= trip.nameTrip %></strong></td>
              <td><%= trip.vRouter %></td>
              <td><%= trip.startLocation %></td>
              <td><%= trip.destination %></td>
              <td>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#editTripModal"
                  onclick='openEditModal(<%- JSON.stringify(trip) %>)'
                >Sá»­a</button>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
      <tbody id="noResultsRow" style="display:none;">
        <tr><td colspan="7" class="text-center">KhÃ´ng tÃ¬m tháº¥y káº¿t quáº£</td></tr>
      </tbody>
    </table>
  </form>
</div>

<!-- Modal thÃªm chuyáº¿n Ä‘i -->
<div class="modal fade" id="addTripModal" tabindex="-1" aria-labelledby="addTripModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="POST" action="/trips/add">
      <div class="modal-header">
        <h5 class="modal-title" id="addTripModalLabel">ThÃªm chuyáº¿n Ä‘i</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ÄÃ³ng"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">MÃ£ chuyáº¿n</label>
          <input type="text" name="tripCode" class="form-control" required value="<%= addTripData ? addTripData.tripCode : '' %>">
        </div>
        <div class="mb-3">
          <label class="form-label">TÃªn chuyáº¿n Ä‘i</label>
          <input type="text" name="nameTrip" class="form-control" required value="<%= addTripData ? addTripData.nameTrip : '' %>">
        </div>
        <div class="mb-3">
          <label class="form-label">Cung Ä‘Æ°á»ng</label>
          <input type="text" name="vRouter" class="form-control" required value="<%= addTripData ? addTripData.vRouter : '' %>">
        </div>
        <div class="mb-3">
          <label class="form-label">Äiá»ƒm xuáº¥t phÃ¡t</label>
          <input type="text" name="startLocation" class="form-control" required value="<%= addTripData ? addTripData.startLocation : '' %>">
        </div>
        <div class="mb-3">
          <label class="form-label">Äiá»ƒm Ä‘áº¿n</label>
          <input type="text" name="destination" class="form-control" required value="<%= addTripData ? addTripData.destination : '' %>">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huá»·</button>
        <button type="submit" class="btn btn-primary">ThÃªm</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal sá»­a chuyáº¿n Ä‘i -->
<div class="modal fade" id="editTripModal" tabindex="-1" aria-labelledby="editTripModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editTripForm" class="modal-content" method="POST" action="">
      <div class="modal-header">
        <h5 class="modal-title" id="editTripModalLabel">Sá»­a chuyáº¿n Ä‘i</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ÄÃ³ng"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="id" id="editTripId" value="<%= editTripData ? editTripData.id : '' %>">
        <div class="mb-3">
          <label class="form-label">MÃ£ chuyáº¿n</label>
          <input type="text" name="tripCode" id="editCodeTrip" class="form-control" required value="<%= editTripData ? editTripData.tripCode : '' %>">
        </div>
        <div class="mb-3">
          <label class="form-label">TÃªn chuyáº¿n Ä‘i</label>
          <input type="text" name="nameTrip" id="editNameTrip" class="form-control" required value="<%= editTripData ? editTripData.nameTrip : '' %>">
        </div>
        <div class="mb-3">
          <label class="form-label">Cung Ä‘Æ°á»ng</label>
          <input type="text" name="vRouter" id="editVRouter" class="form-control" required value="<%= editTripData ? editTripData.vRouter : '' %>">
        </div>
        <div class="mb-3">
          <label class="form-label">Äiá»ƒm xuáº¥t phÃ¡t</label>
          <input type="text" name="startLocation" id="editStartLocation" class="form-control" required value="<%= editTripData ? editTripData.startLocation : '' %>">
        </div>
        <div class="mb-3">
          <label class="form-label">Äiá»ƒm Ä‘áº¿n</label>
          <input type="text" name="destination" id="editDestination" class="form-control" required value="<%= editTripData ? editTripData.destination : '' %>">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Huá»·</button>
        <button type="submit" class="btn btn-primary">LÆ°u thay Ä‘á»•i</button>
      </div>
    </form>
  </div>
</div>

<script>
  function filterTable() {
    const input = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll("#tripTable tbody tr:not(#noResultsRow tr)");
    let visibleCount = 0;
    rows.forEach(row => {
      // TÃ¬m trong cá»™t TÃªn chuyáº¿n (cá»™t thá»© 3)
      const name = row.querySelector('td:nth-child(3)').innerText.toLowerCase();
      if(name.includes(input)) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });
    document.getElementById('noResultsRow').style.display = visibleCount === 0 ? '' : 'none';
  }

  const deleteBtn = document.getElementById('deleteSelectedBtn');
  const selectAll = document.getElementById('selectAll');

  function updateDeleteBtn() {
    const checkboxes = document.querySelectorAll('.rowCheckbox');
    const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
    deleteBtn.classList.toggle('d-none', !anyChecked);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const checkboxes = document.querySelectorAll('.rowCheckbox');
    checkboxes.forEach(cb => cb.addEventListener('change', updateDeleteBtn));
    
    selectAll.addEventListener('change', () => {
      checkboxes.forEach(cb => cb.checked = selectAll.checked);
      updateDeleteBtn();
    });

    // Náº¿u cÃ³ lá»—i thÃªm chuyáº¿n, má»Ÿ modal thÃªm chuyáº¿n
    <% if (addTripError) { %>
      var addTripModal = new bootstrap.Modal(document.getElementById('addTripModal'));
      addTripModal.show();
    <% } %>

    // Náº¿u cÃ³ lá»—i sá»­a chuyáº¿n, má»Ÿ modal sá»­a chuyáº¿n vÃ  Ä‘iá»n dá»¯ liá»‡u vÃ o form
    <% if (editTripError) { %>
      var editTripModal = new bootstrap.Modal(document.getElementById('editTripModal'));
      editTripModal.show();

      // Äá»• dá»¯ liá»‡u lá»—i sá»­a vÃ o form
      document.getElementById("editTripId").value = "<%= editTripData.id %>";
      document.getElementById("editCodeTrip").value = "<%= editTripData.tripCode %>";
      document.getElementById("editNameTrip").value = "<%= editTripData.nameTrip %>";
      document.getElementById("editVRouter").value = "<%= editTripData.vRouter %>";
      document.getElementById("editStartLocation").value = "<%= editTripData.startLocation %>";
      document.getElementById("editDestination").value = "<%= editTripData.destination %>";
      document.getElementById("editTripForm").action = "/trips/edit/<%= editTripData.id %>";
    <% } %>
  });

  function submitDeleteSelected() {
    if (confirm("Báº¡n cháº¯c cháº¯n muá»‘n xÃ³a cÃ¡c chuyáº¿n Ä‘i Ä‘Ã£ chá»n?")) {
      document.getElementById('deleteSelectedForm').submit();
    }
  }

  function openEditModal(trip) {
    document.getElementById("editTripId").value = trip.id;
    document.getElementById("editCodeTrip").value = trip.tripCode;
    document.getElementById("editNameTrip").value = trip.nameTrip;
    document.getElementById("editVRouter").value = trip.vRouter;
    document.getElementById("editStartLocation").value = trip.startLocation;
    document.getElementById("editDestination").value = trip.destination;
    document.getElementById("editTripForm").action = "/trips/edit/" + trip.id;
  }
</script>
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
